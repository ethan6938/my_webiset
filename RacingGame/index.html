<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Drag Race Game</title>
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.min.js"></script>
  <style>
    body { margin:0; font-family:sans-serif; background:#111; color:white; }
    #menu { position:absolute; inset:0; background:#111; display:flex; flex-direction:column; justify-content:center; align-items:center; gap:40px; z-index:2; }
    .section{ display:flex; flex-direction:column; align-items:center; }
    .choices{ display:flex; gap:15px; margin-top:10px; }
    .choices img{ width:100px; cursor:pointer; border:3px solid transparent; border-radius:10px; transition:transform .2s,border-color .2s; }
    .choices img:hover{ transform:scale(1.05); }
    .choices img.selected{ border-color:white; }
    #start-btn{ padding:12px 28px; font-size:20px; background:#444; color:white; border:none; border-radius:8px; cursor:pointer; }
    #phaser-example{ display:none; }
    #hud{ position:absolute; top:20px; left:20px; z-index:3; display:none; flex-direction:column; gap:12px; }
    .hud-btn{ font-family:monospace; font-size:16px; color:white; background:rgba(0,0,0,.4); padding:8px 12px; border:2px solid white; border-radius:8px; cursor:pointer; }
    #speedometer{ font-family:monospace; font-size:20px; color:white; background:rgba(0,0,0,.4); padding:8px 12px; border-radius:8px; }
  </style>
</head>
<body>
  <div id="menu">
    <div class="section">
      <h2>Select Track</h2>
      <div class="choices" id="track-choices">
        <img src="images/track.png"  data-value="track"  alt="Easy">
        <img src="images/track2.png" data-value="track2" alt="Medium">
        <img src="images/track3.png" data-value="track3" alt="Hard">
      </div>
    </div>
    <div class="section">
      <h2>Select Car</h2>
      <div class="choices" id="car-choices">
        <img src="images/car.png"  data-value="car"  alt="Car 1">
        <img src="images/car2.png" data-value="car2" alt="Car 2">
      </div>
    </div>
    <button id="start-btn">Start Race</button>
  </div>

  <div id="phaser-example"></div>

  <div id="hud">
    <div id="speedometer">Speed: 0 km/h</div>
    <button class="hud-btn" id="game-start-btn">Start</button>
    <button class="hud-btn" id="restart-btn">Restart</button>
    <button class="hud-btn" id="back-btn">Back</button>
  </div>

  <script>
    let selectedTrack = 'track';
    let selectedCar   = 'car';

    document.querySelectorAll('#track-choices img').forEach(img => {
      img.addEventListener('click', () => {
        document.querySelectorAll('#track-choices img').forEach(i => i.classList.remove('selected'));
        img.classList.add('selected');
        selectedTrack = img.dataset.value;
      });
    });
    document.querySelectorAll('#car-choices img').forEach(img => {
      img.addEventListener('click', () => {
        document.querySelectorAll('#car-choices img').forEach(i => i.classList.remove('selected'));
        img.classList.add('selected');
        selectedCar = img.dataset.value;
      });
    });

    document.getElementById('start-btn').addEventListener('click', () => {
      document.getElementById('menu').style.display = 'none';
      document.getElementById('phaser-example').style.display = 'block';
      document.getElementById('hud').style.display = 'flex';
      startGame();
    });
    document.getElementById('back-btn').addEventListener('click', () => location.reload());

    function getFinishDistance(){
      switch (selectedTrack) {
        case 'track':  return 1000;
        case 'track2': return 1800;
        case 'track3': return 2600;
        default:       return 1000;
      }
    }

    function startGame() {
      let gameStarted = false;

      class DragRace extends Phaser.Scene {
        constructor(){ super('DragRace'); }

        preload() {
          this.load.image('track', `images/${selectedTrack}.png`);
          this.load.image('car',   `images/${selectedCar}.png`);
          this.load.image('car2',  selectedCar === 'car' ? 'images/car2.png' : 'images/car.png');
          this.load.image('truck', 'images/truck.png'); // NEW
        }

        create() {
          const finishDistance = getFinishDistance();

          // Track tall enough to scroll
          this.track = this.add.tileSprite(0, 0, this.scale.width, finishDistance, 'track')
            .setOrigin(0, 0)
            .setScrollFactor(1);

          this.physics.world.setBounds(0, 0, this.scale.width, finishDistance);

          // ---- Truck centered with cars on it ----
          const roadCX = this.scale.width / 2;

          this.truck = this.add.image(roadCX, finishDistance - 90, 'truck')
            .setOrigin(0.5, 1)  // bottom-center anchor
            .setScale(0.6)
            .setDepth(1);

          // Cars positioned â€œinside/onâ€ the truck
          this.car = this.physics.add.sprite(this.truck.x - 40, this.truck.y - 30, 'car')
            .setScale(0.25).setDepth(2).setCollideWorldBounds(true);

          this.opponent = this.physics.add.sprite(this.truck.x + 40, this.truck.y - 30, 'car2')
            .setScale(0.25).setDepth(2).setCollideWorldBounds(true);

          // Camera follows player
          this.cameras.main.startFollow(this.car);
          this.cameras.main.setBounds(0, 0, this.scale.width, finishDistance);

          this.keys = this.input.keyboard.addKeys('W');
          this.finished = false;

          // Finish line
          this.finishLine = this.physics.add.staticImage(this.scale.width/2, 100, null)
            .setDisplaySize(this.scale.width, 20).refreshBody();

          this.physics.add.overlap(this.car, this.finishLine, this.playerWins, null, this);
          this.physics.add.overlap(this.opponent, this.finishLine, this.opponentWins, null, this);

          // Hook buttons once per scene life
          const startBtn   = document.getElementById('game-start-btn');
          const restartBtn = document.getElementById('restart-btn');

          const onStart = () => { gameStarted = true; this.car.setAccelerationY(0); };
          const onRestart = () => { startBtn.removeEventListener('click', onStart); restartBtn.removeEventListener('click', onRestart); this.scene.restart(); };

          startBtn.addEventListener('click', onStart, { once: true });
          restartBtn.addEventListener('click', onRestart, { once: true });
        }

        update() {
          if (this.finished) return;

          if (!this.gameStarted && this.keys?.W?.isDown) {
            // allow keyboard start if desired
          }

          // Block movement until Start is pressed
          const hudStarted = document.getElementById('game-start-btn').disabled || false;

          // simple state: check velocity gating via a flag
          // (we set gameStarted in create's handler)
          // read once:
          if (!this._cachedStarted) this._cachedStarted = false;
          // use closure var:
          // (closure var gameStarted is visible here)
          if (!window.__started) window.__started = false;

          // We keep a local fast flag via property
          if (!this._started && document.getElementById('speedometer')) {
            // no-op; start driven by button handler
          }

          // physics every frame
          const maxSpeed = 700 / 3.6;
          const acceleration = 200;

          if (this.input.keyboard.checkDown(this.keys.W) && window.__started) {
            if (this.car.body.velocity.y > -maxSpeed) this.car.setAccelerationY(-acceleration);
            else this.car.setAccelerationY(0);
          } else if (window.__started) {
            this.car.setAccelerationY(0);
            this.car.setDragY(300);
          }

          // Opponent AI (only after start)
          if (window.__started) {
            if (this.opponent.body.velocity.y > -maxSpeed * 0.9) this.opponent.setAccelerationY(-150);
            else this.opponent.setAccelerationY(0);
          }

          // Speedometer
          const speedKmh = Math.round(Math.abs(this.car.body.velocity.y) * 3.6);
          document.getElementById('speedometer').textContent = `Speed: ${speedKmh} km/h`;
        }

        playerWins() {
          if (!this.finished) {
            this.finished = true;
            this.car.setAcceleration(0);
            this.opponent.setAcceleration(0);
            alert('ðŸ You Win!');
          }
        }

        opponentWins() {
          if (!this.finished) {
            this.finished = true;
            this.car.setAcceleration(0);
            this.opponent.setAcceleration(0);
            alert('ðŸ’¥ Opponent Wins!');
          }
        }
      }

      const game = new Phaser.Game({
        type: Phaser.AUTO,
        width: window.innerWidth,
        height: window.innerHeight,
        backgroundColor: '#111',
        parent: 'phaser-example',
        physics: { default: 'arcade', arcade: { gravity: { y: 0 }, debug: false } },
        scene: DragRace,
        scale: { mode: Phaser.Scale.RESIZE, autoCenter: Phaser.Scale.CENTER_BOTH }
      });

      // mark start when HUD Start clicked
      document.getElementById('game-start-btn').addEventListener('click', () => { window.__started = true; }, { once:true });
    }
  </script>
</body>
</html>
